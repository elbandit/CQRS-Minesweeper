@model Columbo.Minesweeper.Application.Queries.Views.MinefieldView
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <title>Index</title>    
    <script src="/Scripts/jquery-1.6.1.js" type="text/javascript"></script>    
    <script src="/Scripts/jquery.tmpl.js" type="text/javascript"></script>    
    <script src="/Scripts/knockout-1.2.1.js" type="text/javascript"></script>
</head>

<script type="text/javascript">

    function row(tiles) {
        this.tiles = ko.observable(tiles);                
    }

    function tile(row, column, has_been_revealed, tile_image, ownerViewModel) {
        this.row = ko.observable(row);
        this.column = ko.observable(column);
        this.has_been_revealed = has_been_revealed;
        this.tile_image = tile_image;


        this.reveal = function () {
            if (this.has_been_revealed != true)
                ownerViewModel.reveal(this);    
        };
        this.ownerViewModel = ownerViewModel;
    }

    
    // Overall viewmodel for this screen, along with initial state
    function taskListViewModel() {

        var self = this;

        this.rows = ko.observableArray([]);
        this.game_won = ko.observable();
        this.game_lost = ko.observable();
      
        this.reveal = function (tile) {
         
            $.post("Game/AjaxReveal", { col: tile.column, row: tile.row }, function (data) {

                self.update_mines();
            });
        };

        this.update_mines = function () {
            $.get("Game/Ajax", function (data) {

                var rows = $.map(data.tile_grid, function (item) {
                    return new row($.map(item, function (tiles) {
                        return new tile(tiles.row, tiles.column, tiles.has_been_revealed, tiles.tile_image, self)
                    }))
                })

                self.game_won(data.game_won);
                self.game_lost(data.game_lost);

                self.rows(rows)
            });
        };

        // Load initial state from server
        self.update_mines();
    }; 
</script>
<body>
    
    <div id="win-message" data-bind="visible: game_won">
        You have won!
    </div>

    <div id="lose-message" data-bind="visible: game_lost">
        You have lost!
    </div>

    <div id="start-new-game" data-bind="visible: game_won || game_lost">
         @using (Html.BeginForm("FinishGame", "Game"))
            {                
                <input id="btnStartNewGame" type="submit" value="Start New Game" />        
                <br /><br />
            }
    </div>    

    <table id="minefield">    
        <tbody data-bind="template: 'reservationTemplate'"></tbody>
    </table>

    <script type="text/x-jquery-tmpl" id="reservationTemplate">
        {{each rows}}
            <tr data-bind="template: { name: 'childrenTemplate', foreach: tiles }"></tr>                 
        {{/each}}
    </script>

    <script type="text/html" id="childrenTemplate">                                
        <td>
            <img id="${row}_${column}" data-bind="click: reveal" border="0" id="EmptyTile" src="/Images/${tile_image}.gif")" />              
        </td>                
    </script> 

    
<script type="text/javascript">

    var viewModel = new taskListViewModel();

    ko.applyBindings(viewModel);

</script>
</body>
</html>
